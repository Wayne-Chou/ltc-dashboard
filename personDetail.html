<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>人員詳細資料</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
  </head>
  <body class="bg-light">
    <div class="container py-4">
      <!-- 返回按鈕 -->
      <button class="btn btn-secondary mb-3" id="backBtn">← 返回上一頁</button>

      <!-- 人名 -->
      <h3 id="personName" class="mb-3 fw-bold"></h3>

      <!-- 基本資料 -->
      <div id="personInfo" class="border rounded bg-white p-3 mb-3"></div>

      <!-- 表格 -->
      <div id="personTable" class="bg-white rounded p-3 shadow-sm"></div>
    </div>

    <script>
      // 綁定返回按鈕
      document.getElementById("backBtn").addEventListener("click", () => {
        history.back(); // 返回上一頁
      });

      // 讀取 sessionStorage 資料
      const data = JSON.parse(sessionStorage.getItem("selectedPersonData"));

      if (data) {
        document.getElementById("personName").textContent = data.name;

        // 顯示基本資料
        document.getElementById("personInfo").innerHTML = `
        <div class="row gx-0 border">
          <div class="col-6 border-end p-2"><strong>姓名:</strong> ${data.name}</div>
          <div class="col-6 p-2"><strong>性別:</strong> ${data.gender}</div>
          <div class="col-6 border-top border-end p-2"><strong>年齡:</strong> ${data.age}</div>
          <div class="col-6 border-top p-2"><strong>風險等級:</strong> ${data.risk}</div>
        </div>
      `;

        // 顯示表格
        if (data.records.length > 0) {
          let html = `
          <div style="max-height: 400px; overflow-y: auto;">
            <table class="table table-bordered align-middle mt-3 mb-0">
              <thead class="bg-light">
                <tr>
                  <th>檢測日期</th>
                  <th>坐站秒數</th>
                  <th>平衡得分</th>
                  <th>步行速度</th>
                  <th>跌倒風險</th>
                </tr>
              </thead>
              <tbody>
        `;

          data.records.forEach((item) => {
            const dateText = item.Date
              ? new Date(item.Date).toLocaleDateString()
              : "未知";

            const allPeople = item.VIVIFRAIL
              ? [].concat(...Object.values(item.VIVIFRAIL))
              : [];
            const personData = allPeople.find((p) => p.Name === data.name);

            const sitStand = personData?.["坐站秒數"] ?? "-";
            const balanceScore = personData?.["平衡得分"] ?? "-";
            const walkSpeed = personData?.["步行速度"] ?? "-";
            const fallRisk = personData?.["跌倒風險"] ?? "-";

            html += `
            <tr>
              <td>${dateText}</td>
              <td>${sitStand}</td>
              <td>${balanceScore}</td>
              <td>${walkSpeed}</td>
              <td>${fallRisk}</td>
            </tr>
          `;
          });

          html += `
              </tbody>
            </table>
          </div>
        `;

          document.getElementById("personTable").innerHTML = html;
        } else {
          document.getElementById("personTable").innerHTML =
            '<div class="text-muted py-2">查無資料</div>';
        }
      } else {
        document.body.innerHTML = `
        <div class="text-center mt-5">
          <p class="text-danger fs-5">查無人員資料</p>
          <button class="btn btn-secondary" onclick="history.back()">返回</button>
        </div>
      `;
      }
    </script>
  </body>
</html>
